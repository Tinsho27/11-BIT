CREATE OR REPLACE FUNCTION verificar_stock()
RETURNS TRIGGER AS $$
DECLARE
    stock_disponible INT;
BEGIN
    SELECT stock INTO stock_disponible
    FROM Videojuego
    WHERE id_videojuego = NEW.id_videojuego;

    IF stock_disponible IS NULL THEN
        RAISE EXCEPTION 'El videojuego no existe.';
    ELSIF NEW.cantidad > stock_disponible THEN
        RAISE EXCEPTION 'Error: no se puede procesar la compra por stock insuficiente';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_verificar_stock
BEFORE INSERT ON Carro_Videojuego
FOR EACH ROW
EXECUTE FUNCTION verificar_stock();
